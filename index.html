
<!Doctype HTML>
<html>
	<head>
		<title> Children in Cambridge, MA </title>
		<!---   Styles   -->
		<link href="http://youarehere.cc/w/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
		<link href="http://youarehere.cc/w/static/bootstrap-select/bootstrap-select.css" rel="stylesheet"/>
		<!-- <link href='http://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'> -->
		<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
		<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
		
		<meta property="og:image" content="http://youarehere.cc/static/media/coffeeshops/cambridge.jpg" />
		<meta property="og:title" content="Children in Cambridge, MA" />
		<link rel="stylesheet" href="http://youarehere.cc/w/static/css/histograms.css" />
		<link href='http://fonts.googleapis.com/css?family=EB+Garamond' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="http://youarehere.cc/w/static/css/coffeeshops.css" />
		<link rel="stylesheet" href="http://youarehere.cc/w/static/css/graffiti.css" />
		<link rel="stylesheet" href="static/css/chain-independent.css" />

		<!---   Scripts    -->
		<script src="http://youarehere.cc/w/static/libs/d3.v3.min.js"></script>
		<script src="http://youarehere.cc/w/static/libs/jquery.min.js"></script>
		<script src="http://youarehere.cc/w/static/libs/d3.tip.js"></script>
		<script src="http://youarehere.cc/w/static/bootstrap/js/bootstrap.min.js"></script>
		<script src="http://youarehere.cc/w/static/bootstrap-select/bootstrap-select.js"></script>
		<script src="http://youarehere.cc/w/static/js/d3-utils.js"></script>
		<script src="http://d3js.org/queue.v1.min.js"></script>
		<script>
		
		function loadAppropriateFonts() {
			if (navigator.platform.toLowerCase().indexOf('mac') == -1) {
				$('body, h1, h2, h3, h4, h5').css('font-family', "'Open Sans', sans-serif");
			}
		}
		$(function(){
		  if (/embed/i.test(window.location.search)){
		    $('body').addClass('embedded');
		    var showOriginal = $(document.createElement('a'));
		    showOriginal.attr('target', 'new');
		    showOriginal.attr('href', window.location.href.replace(window.location.search, '?more=1'));
		    showOriginal.html('... more');
		    showOriginal.attr('id', 'showOriginal');
		    $('#showMore').replaceWith(showOriginal);
		  }
		  if (/more/i.test(window.location.search)){
		    setTimeout(function(){$('#showMore').click();},1000);
		  }
		});
		</script>

		<style type="text/css">
		  .embedded {
		    overflow: hidden;
		  }
		  .embedded .navElements {
		    display: none;
		  }
		  .embedded #footer {
		    display: none;
		  }
		  #showOriginal { color: #DE1028 }
		  .embedded .title-container {
		    margin-top: 0;
		  }
		  .title-logo {
		    display: none;
		    float: left;
		    width: 40px;
		    height: 40px;
		    margin-right: 5px;
		  }
		  .title-logo img { width: 100%; height: 100% }
		  .embedded .title-logo {
		    display: block;
		  }
		  .embedded > .container {
		    margin-bottom: 0;
		  }
		  .embedded .title {
		    font-size: 18px !important;
		  }
		  .embedded .subtitle {
		    font-size: 12px !important;
		  }
		</style>

<script src="http://youarehere.cc/w/static/libs/topojson.v1.min.js"></script>

<script>
var labels = [1970, 1980, 1990, 2000, 2010];
var yearPointsMap = d3.map();
var tip;
var kmToMile = 0.621371; 
var color = d3.scale.linear().domain([0, 50]).range(['blue', 'red']);
var line = d3.svg.line()
	.interpolate("basis-closed")
	.x(function (d) { return d[0]})
	.y(function (d) { return d[1]});

var notInCambridge = d3.set([48,12,67,93])
window.onload = function () {
	// Load fonts.
	loadAppropriateFonts();

	// Set up map.
	var mapOptions = {
		src: 'static/data/boundaries/cambridge.geojson', 
		width: 1000, 
		height: 600,
		scale: 1.0,
		svgContainer: '#mapContainer',
		roads: 'static/data/roads/cambridge.json',
		lookup: 'cambridge',
	}
	map = new D3Map(mapOptions); 
	queue()
		.defer(d3.json, '../static/data/age/age1970.json')
		.defer(d3.json, '../static/data/age/age1980.json')
		.defer(d3.json, '../static/data/age/age1990.json')
		.defer(d3.json, '../static/data/age/age2000.json')
		.defer(d3.json, '../static/data/age/age2010.json')
		.await(setup);
}

function setup(error, data1970, data1980, data1990, data2000, data2010) {	
	map.loadGeoJSON(function () {
		// Set up map color?
		map.svg.select('path').attr('fill', '#ededed').attr('opacity', 0.0)
			.on('mouseenter', function () { 
			})
			.on('mouseleave', function () { 
				map.svg.select('.tip').attr('opacity', 0.0);
			})
		var path = d3.geo.path().projection(map.projection);
		yearPointsMap.set(2010, data2010);
		yearPointsMap.set(2000, data2000);
		yearPointsMap.set(1990, data1990);
		yearPointsMap.set(1980, data1980);
		yearPointsMap.set(1970, data1970);
		setupHelper();
		drawAllPoints(yearPointsMap.get('2010'));
		drawAllTracts(yearPointsMap.get('2010'));
		drawHistogram(yearPointsMap.get('2010').data.cambridge);
		drawGraph();
		setupPlayButton();
	}); 
}

function setupHelper() {
	var legend = map.svg.append('g')
		.attr('transform', 'translate(100, 500)'); 
	
	var tip = map.svg.append('g')
		.attr('class', 'tip')
		.attr('transform', 'translate(20,20)')
		.attr('pointer-events', 'none')
		.attr('opacity', 0.0)

	tip.append('rect')
		.attr('x', 30).attr('y', 0)
		.attr('width', 20)
		.attr('height', 20)
		.attr('fill', 'black')
		.attr('rx', 2)
		.attr('ry', 2);
		
	tip.append('text')
		.attr('class', 'tip-text')
		.attr('x', 40)
		.attr('y', 16)
		.attr('fill', 'white')
		.text('hello');

	var line2 = d3.svg.line()
		.x(function (d) { return d[0]})
		.y(function (d) { return d[1]});
	tip.append('path')
		.attr('d', line2([[0,12], [30,12]]))
		.attr('stroke', 'black')
		.attr('fill', 'none');
	
	tip.append('circle')
		.attr('cx', 0)
		.attr('cy', 12)
		.attr('r', 3);
	
	var essayBoxShown = false;
	$('#showMore').click(function(e){
		e.preventDefault();
		map.svg.select('.tip').attr('opacity', 0.0);
		window.location.hash = '#/description';
	    essayBoxShown = !essayBoxShown;
		if (essayBoxShown) {
			$('#essayBox').css('display', 'block');
		    $('#essayBox').animate({'opacity':1.0}, 500);
			$(this).text(' ... view map ');
		} else {
			closeEssayBox();
			$(this).text(' ... more ');
		}
		
	  })
 
	  $('#essayBox-close').click(function(){
	    closeEssayBox();
		$('#showMore').text(' ... more ');
	  });
	  
	  $('#essayBox').click(function () {
		  closeEssayBox(); 
		  $('#showMore').text(' ... more ');
	  });
  
	 function closeEssayBox(){
	  $('#essayBox').animate({'opacity':0.0}, 500, function () {
	  	$('#essayBox').css('display', 'none');
	  })
      essayBoxShown = false;
	}
	
	$('#viewMap').on('click', function (e) {
		e.preventDefault(); 
	}); 
	
	
	window.onhashchange = function () {
		//console.log('event', location.hash)
		if (location.hash == '') {
			closeEssayBox(); 
		}
	}
	drawLegend();
}

function drawLegend() {
  var color_domain = [0, 10, 20, 30, 40, 50]
  var legend_labels = ["0", "10", "20", "30", "40", "50"]              
  var legend = map.svg.selectAll("g.legend")
  .data(color_domain)
  .enter().append("g")
  .attr("class", "legend");

  var ls_w = 20, ls_h = 20;

  legend.append("rect")
  .attr("x", 20)
  .attr("y", function(d, i){ return 500 - (i*ls_h) + 2*ls_h;})
  .attr("width", ls_w)
  .attr("height", ls_h)
  .style("fill", function(d, i) { return color(d); })
  .style("opacity", 0.8);

  legend.append("text")
  .attr("x", 50)
  .attr("y", function(d, i){ return 500 - (i*ls_h) + 3*ls_h - 4;})
  .text(function(d, i){ return legend_labels[i]; });

	var description = ["under 18", "Percent of population"];

	var legend_description = map.svg.selectAll("g.legend_description")
	.data(description)
	.enter().append("g")
	.attr("class", "legend_description")
	
	legend_description.append("text")
	.attr("x", 20)
  .attr("y", function(d, i){ return 500 - (i*ls_h) - 3*ls_h - 4;})
	.text(function(d, i){ return description[i];});

/*

	var data = [1, 2, 3, 5, 8, 13, 21];
	var padding = {left: 200, right: 70, top: 5}; 
	var graphWidth = 945 - padding.right - padding.left;

	var graphHeight = 60 - padding.top;
	var x = d3.scale.linear().domain([10])
	    .range([0, graphWidth]);

	var xAxis = d3.svg.axis().scale(x);
	
	// Create xAxis.
	legend.append('g')
		.attr('class', 'axis')
		.attr('transform', 'translate(0,' + (graphHeight - 25) + ')')
		.call(xAxis);


	var margin = {top: 10, right: 30, bottom: 30, left: 30},
  		width = 960 - margin.left - margin.right,
			height = 500 - margin.top - margin.bottom;

	var x = d3.scale.linear()
	.domain([0, 25])
	.range([0, width]);

	var xAxis = d3.svg.axis()
	.scale(x)
	.orient("left")
	.tickValues(data)
	.innerTickSize([250])
	.outerTickSize([250]);

	var legend_bar = map.svg.selectAll("g.legend_bar")
	.append("g")
	.attr("class", "y axis")
	.attr("transform", "translate(0," + height + ")")
	.call(xAxis);
*/
}


function drawTract(tract, mapTractPoints) {
	var points = mapTractPoints.points[tract];
	var vertices = points.map(function (d, i) { d.coords = map.projection([d.lng, d.lat]); return d.coords;}); 
	var hull = d3.geom.hull(vertices); 
	map.svg.append('path')
				.datum(tract)
				.attr("d", line(hull))
				.attr('fill', color)
				.attr('fill-opacity', 0.0)
				.attr('stroke', 'gray')
				.attr('stroke-width', 2)
				.attr('stroke-opacity', 0.0)
				.attr('stroke-dasharray', '5 5')
				.attr('class', 'hull')
				.on('mouseover', function (d) {
					var location = map.projection([d.lng, d.lat]);
					var text = map.svg.select('.tip-text').text(d.tract).attr('opacity', 1.0);
					var bbox = text.node().getBBox();
					var x = location[0]; var y = location[1]-bbox.height/2 - 5; 
					//map.svg.select('.tip').transition().attr('transform', 'translate(' + x + ',' + y + ')').attr('opacity', 0.7);
					//map.svg.select('.tip').select('rect').attr('width', bbox.width + 20).attr('height', bbox.height + 10);
					d3.select(this).transition().attr('fill-opacity', 0.1).attr('stroke-opacity', 0.8);
				 })
				.on('mouseleave', function (d) {
					d3.select(this).transition().attr('fill-opacity', 0.0).attr('stroke-opacity', 0.0);
				});
}

function drawAllTracts(mapTractPoints) {
	var tracts = mapTractPoints.tracts;
	tracts.forEach(function(d) {
		drawTract(d, mapTractPoints);
	});
}

function drawAllPoints(mapTractPoints) {
	map.svg.selectAll('circle').remove();
	var tracts = mapTractPoints.tracts;
	tracts.forEach(function(d) {
		drawPoints(mapTractPoints.points[d]);
	});
}

function drawPoints(points) {
	map.tip.direction('ne');
	var vertices = points.map(function (d, i) { d.coords = map.projection([d.lng, d.lat]); return d.coords;}); 

	// Place children dots.	
	map.svg.selectAll('.circle')
		.data(points)
		.enter().append('circle')
		.attr('cx', function (d) { return d.coords[0];})
		.attr('cy', function (d) { return d.coords[1];})
		.attr('r', 1.5)
		.attr('fill', function (d) { d.color = color(d.density); return d.color; })
		.attr('opacity', 0)
		// Set opacity porportional to distance.
		.attr('opacity', function (d, i) {
			if (d.max_distance < 1000) {
				return 0.8 * Math.pow(1.0 - (d.distance / d.max_distance), 2);
			}
			return 0.8 * Math.pow(1.0 - (d.distance / 1000), 2);
		});
}

function drawGraph() {
	var padding = {left: 200, right: 70, top: 5}; 
	var graphWidth = 945 - padding.right - padding.left;
	var graphHeight = 60 - padding.top;
	
	var svg = d3.select('#graphContainer')
		.append('svg')
		.attr('width', graphWidth + padding.left + padding.right)
		.attr('height', graphHeight)
		.append('g')
		.attr('transform', 'translate(' + padding.left + ',' + padding.top + ')');
	graphSvg = svg;
	
	
	var tip = d3.tip()
		.attr('class', 'd3-tip')
		.offset([0, 10])
		.direction('e')
		.html(function(d) {
			return "<div style=' max-width: 200px; font-weight: normal; text-align: center;'>" + d + "</div>";
		});
	svg.call(tip);


	// Create x and y scales.
	var totalHouseholds = [];
	yearPointsMap.keys().forEach(function (d) { totalHouseholds.push(yearPointsMap.get(d).data.cambridge.children); return d;});
	var minChildrenHouseholds = d3.min(totalHouseholds);
	var maxChildrenHouseholds = d3.max(totalHouseholds);
	
	// var x = d3.scale.linear().domain([0, 11]).range([0, graphWidth]);
	var y = d3.scale.linear().domain([minChildrenHouseholds, maxChildrenHouseholds]).range([30, 0]);
	
	var x = d3.scale.ordinal()
        .domain(labels) 
		.rangeRoundBands([0, graphWidth], 0.05);
	var xAxis = d3.svg.axis().scale(x);
	
	// Create xAxis.
	svg.append('g')
		.attr('class', 'axis')
		.attr('transform', 'translate(0,' + (graphHeight - 25) + ')')
		.call(xAxis);
	
	var line = d3.svg.line()
		.x(function (d) { return x(d)+ x.rangeBand()/2.0 })
		.y(function (d) { return y(yearPointsMap.get(d).data.cambridge.children); });
	
	svg.append('path')
		.datum(labels)
		.attr('class', 'line')
		.attr('d', line);
	
	// Draw dots.
	svg.selectAll('circle')
		.data(labels)
		.enter().append('circle')
		.attr('class', 'line-dot')
		.attr('cx', line.x())
		.attr('cy', line.y())
		.attr('r', 3)
		.attr('fill', '#D6D6D6')
		// Tips not working.
		/*
		.on('mouseover', function (d, i) {
			d3.select(this).attr('r', 5);
			d.text = yearPointsMap.get(d).data.cambridge.children + ' children in ' + labels[i];
			d.text = "tits";
			tip.show(d.text);
		})*/
		.on('mouseout', function (d) {
			d3.selectAll('.line-dot')
				.attr('r', function (d) {
					if (d3.select(this).attr('is-clicked') == 'true') return 5;
					return 3;
				})
			tip.hide();
		})
		.on('click', function (d) {
			gData = d.values; 
			drawAllPoints(yearPointsMap.get(d));
			drawHistogram(yearPointsMap.get(d).data.cambridge);
			d3.selectAll('.line-dot').attr('fill', '#D6D6D6').attr('is-clicked', 'false');
			d3.select(this).attr('r', 5).attr('fill', '#FC6262').attr('is-clicked', 'true');
		});
}

function setupPlayButton() {
  var i = 0;
  d3.select('#playButton')
    .on('click', function () {
      d3.event.preventDefault();
      var callId = setInterval(function () {
        drawAllPoints(yearPointsMap.get(labels[i]));
				drawHistogram(yearPointsMap.get(labels[i]).data.cambridge);
        d3.selectAll('.line-dot')
          .transition()
          .attr('fill', function (d, j) {
            if (j == i) return '#FC6262';
            return '#D6D6D6';
          })
          .attr('r', function (d, j) {
            if (j == i) return 5;
            return 3;
          });
        i++;
        if (i >= labels.length) {
          i = 0;
          clearInterval(callId);
        }
      }, 3000);
    });
}

function drawHistogram(data) {
	graphSvg = d3.select('#histogramContainer');
	graphSvg.selectAll('svg').remove();

	graphSvg = d3.select('#histogramContainer').append('svg')
		.attr('width', 300)
		.attr('height', 100); 
	
  graphSvg.append("linearGradient")                
          .attr("id", "independentGradient")            
          .attr("gradientUnits", "userSpaceOnUse")    
          .attr("x1", '0').attr("y1", '0')         
          .attr("x2", '100%').attr("y2", '0')      
      .selectAll("stop")                      
          .data([                             
              {offset: "0%", color: '#A7DE1D'},       
              {offset: "50%", color: '#A7DE1D'}, 
              {offset: "75%", color: '#5EB56A'},   
          ])                  
      .enter().append("stop")         
          .attr("offset", function(d) { return d.offset; })   
          .attr("stop-color", function(d) { return d.color; });
  
	var children = data.children;
	var population = data.population;
	var numbers = [children, population];
	graphSvg.selectAll('.bar')
		.data(numbers)
		.enter().append('rect')
		.attr('class', function (d, i) {
			return 'bar ' + (i == 0 ? 'children' : 'population');
		})
		.attr('x', 300)
		.attr('y', function (d, i) { return i * 20 })
		.attr('width', 0)
		.attr('height', 15)
		.transition()
		.duration(2000)
		.attr('x', function (d) { return 300 - (d / 500)})
		.attr('width', function (d) { return (d / 500)});
	
	
	graphSvg.selectAll('text')
		.data(numbers)
		.enter().append('text')
		.attr('x', function (d, i) { return 290 - (d / 500)})
		.attr('y', function (d, i) { return i * 20 + 10; })
		.attr('text-anchor', 'end')
	var text = [children + ' children', population + ' people']
	graphSvg.selectAll('text')
		.data(text)
		.text(function (d) { return d })
	d3.select('#location').text(data.name);	
}

</script>

	</head>
	<body>
		
<div class="container">
	<div class="title-container">
			<a id="logo" href="http://youarehere.cc">
				<img src="http://youarehere.cc/w/static/img/logo.jpg" style="width: 50px">
			</a>
			<div class="title-text">
				<a href="http://youarehere.cc/#/maps/by-city/cambridge" id="mapClass">
					<h3 class="title" style="font-size: 36px; color:#545454"> Cambridge </h3>
				</a> 
				<div class="subtitle">
					This map shows the location of households with children in cambridge
					<a id="showMore" href="#"> ... more </a>
				</div>
			</div>
			<div class="spacer"></div>
	</div>
	<div id="graphContainer">
		<div class="graph-title">
			<h4>Over Time</h4>
			<a id="playButton" href="#"> <i class="fa fa-play"></i> Play Animation </a>
		</div>
	</div>
	<div id="content">
		<div id="mapContainer">
		</div>
		<div id="histogramContainer">
			<h4 id="location">Cambridge</h4>
		</div>
	</div>
		<div id='essayBox'>
		    <div id='essayBox-close' class="glyphicon glyphicon-remove"></div>

		    <div id='essayContent'>
		 		<p>
		 			This map shows housholds with children under the age of 18. 
		 		</p>

		 		<p>
				Something about why this visualization is useful?
		 		</p>
		 		<p>
				The data displayed by this map was generated from 50 years of <a href="https://data2.nhgis.org/">census data</a>, which told us the number of households in a given census tract and which ones had at least one child under age 18. Other stuff here.
		 		</p>
		 		<p>
				In the final map each point represents a single houshold with children.  The color of each point indicates the relative density of households with children in that particular block group or census tract.
										
		 		</p>
		 		<h4> Data Sources </h4>
		 		<ol>
		 			<li><a href="https://data2.nhgis.org/"> National Historical Geographic Information System </a></li>
		 		</ol>
				
				<a id="viewMap" href="#"> View Map</a>
		    </div>
		  </div>
		  <div id="footer">
	<div class="pull-left">
		
		This work is part of the <a href="/">You Are Here</a> project 
		<span class="footer-plus">+</span>
		<a href="http://socialcomputing.media.mit.edu"> The Social Computing Group </a>
		<span class="footer-plus">+</span>
		<a href="http://media.mit.edu"> MIT Media Lab </a>
		<span class="footer-plus">+</span>
		<a href="http://www.mit.edu">Massachusetts Institute of Technology</a>
	</div>
	<div class="pull-right">
		<a href="/#/report"> Report an Issue <i class="fa fa-comment-o"></i></a>
		<span class="footer-plus">|</span>
		<script type="text/javascript">
		  function embedMe(){
		    // We subtracting 48px from the height to
		    // approximately account for embed mode not having
		    // a footer and having a smaller title.
		    var params = {
		      map: window.location.href,
		      width: $('body > .container').outerWidth(),
		      height: $('body > .container').outerHeight() - 48
		    };
		    window.location.href = '/#/embed/'+encodeURIComponent(JSON.stringify(params));
		  }
		</script>
		<a href="#" onclick="embedMe()">Embed</a>
		<span class="footer-plus">|</span>
		<a href="/#/faq"> FAQ </a>
	</div>
</div>

</div>

	</body>
</html>

